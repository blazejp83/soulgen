---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/app/api/chat/route.ts
  - src/lib/providers.ts
  - src/app/settings/page.tsx
  - src/components/api-key-input.tsx
  - src/components/provider-selector.tsx
  - src/components/mode-toggle.tsx
  - src/components/app-header.tsx
  - src/app/layout.tsx
  - package.json
autonomous: true
---

<objective>
Build the streaming LLM proxy API route with multi-provider adapter, settings page with API key management, provider/model selection, and Simple/Advanced mode toggle in the app header.

Purpose: Complete all Phase 1 requirements — users can configure their LLM provider, enter API keys, select models, and toggle Simple/Advanced mode. The streaming API route is ready for Phase 3 generation.
Output: Working settings page, streaming API route, provider abstraction, mode toggle.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Prior plan output:
@.planning/phases/01-foundation/01-01-SUMMARY.md

Source files from Plan 01:
@src/types/index.ts
@src/stores/settings-store.ts
@src/stores/wizard-store.ts
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create multi-provider adapter and streaming API route</name>
  <files>src/lib/providers.ts, src/app/api/chat/route.ts, package.json</files>
  <action>
    1. Install AI SDK and provider packages:
       `pnpm add ai @ai-sdk/openai @ai-sdk/anthropic @ai-sdk/openrouter`

    2. Create provider adapter (src/lib/providers.ts):
       - Function `getProvider(provider: Provider, apiKey: string)` that returns the appropriate AI SDK provider instance:
         - 'openai' → createOpenAI({ apiKey })
         - 'anthropic' → createAnthropic({ apiKey })
         - 'openrouter' → createOpenRouter({ apiKey })
       - Function `getModel(provider: Provider, apiKey: string, modelId: string)` that calls getProvider and returns the model instance
       - Hardcoded model lists for OpenAI and Anthropic:
         ```
         OPENAI_MODELS = [
           { id: 'gpt-4o', name: 'GPT-4o' },
           { id: 'gpt-4o-mini', name: 'GPT-4o Mini' },
           { id: 'gpt-4.1', name: 'GPT-4.1' },
           { id: 'gpt-4.1-mini', name: 'GPT-4.1 Mini' },
           { id: 'gpt-4.1-nano', name: 'GPT-4.1 Nano' },
         ]
         ANTHROPIC_MODELS = [
           { id: 'claude-sonnet-4-20250514', name: 'Claude Sonnet 4' },
           { id: 'claude-haiku-3-5-20241022', name: 'Claude 3.5 Haiku' },
         ]
         ```
       - Export model lists for UI consumption
       - Export a `getModelList(provider: Provider)` function (for OpenRouter, this will be dynamic later; for now return a placeholder list)

    3. Create streaming API route (src/app/api/chat/route.ts):
       - POST handler that accepts JSON body: `{ provider, apiKey, model, messages, system? }`
       - Validate required fields (return 400 if missing)
       - Use `getModel()` to get provider instance
       - Use AI SDK `streamText()` to stream response
       - Return `result.toDataStreamResponse()` for client consumption
       - Wrap in try/catch: return 500 with error message on failure (don't expose apiKey in error)
       - Set `maxDuration: 60` export for Vercel timeout (Hobby tier allows up to 60s for streaming)

    IMPORTANT: The API key comes from the client per-request in the body. This is the proxy pattern — client sends key to our API route, route uses it server-side to call the LLM provider. The key never appears in client-side network calls to external providers.
  </action>
  <verify>
    - `pnpm run build` passes
    - API route file exists and exports POST handler
    - Provider adapter exports getModel and model lists
  </verify>
  <done>
    - Streaming API route at /api/chat accepts provider/key/model/messages and streams response (PROV-03)
    - Provider adapter supports OpenAI, Anthropic, OpenRouter (PROV-01)
    - Hardcoded model lists for OpenAI/Anthropic, placeholder for OpenRouter (PROV-02)
  </done>
</task>

<task type="auto">
  <name>Task 2: Build settings page with API key management, provider selection, and mode toggle</name>
  <files>src/app/settings/page.tsx, src/components/api-key-input.tsx, src/components/provider-selector.tsx, src/components/mode-toggle.tsx, src/components/app-header.tsx, src/app/layout.tsx</files>
  <action>
    1. Create ApiKeyInput component (src/components/api-key-input.tsx):
       - Client component ("use client")
       - Text input for API key with show/hide toggle button (eye icon)
       - Input type toggles between "password" and "text"
       - On change, calls settingsStore.setApiKey(provider, value)
       - Shows privacy note: "Stored locally in your browser. Never sent to our servers."
       - Covers: AKEY-01, AKEY-02, AKEY-03

    2. Create ProviderSelector component (src/components/provider-selector.tsx):
       - Client component
       - Tab-style or radio group for selecting provider (OpenAI | Anthropic | OpenRouter)
       - On select, calls settingsStore.setActiveProvider(provider)
       - Below provider selector, show model dropdown populated from getModelList(activeProvider)
       - On model change, calls settingsStore.setModel(provider, model)
       - Below model dropdown, show ApiKeyInput for the active provider
       - Covers: PROV-01, PROV-02, AKEY-04

    3. Create ModeToggle component (src/components/mode-toggle.tsx):
       - Client component
       - Switch/toggle between "Simple" and "Advanced" labels
       - Uses settingsStore.mode and settingsStore.setMode()
       - Compact enough to place in header
       - Covers: MODE-01, MODE-02

    4. Create AppHeader component (src/components/app-header.tsx):
       - Client component
       - Shows "SoulGen" brand text on left
       - ModeToggle in center or right area
       - Settings icon/link to /settings on right
       - Sticky top, minimal height, dark themed

    5. Create Settings page (src/app/settings/page.tsx):
       - Client component
       - Page title: "Settings"
       - ProviderSelector component (provider tabs + model dropdown + API key input)
       - Back link to home
       - Clean card-based layout using shadcn Card components

    6. Update layout (src/app/layout.tsx):
       - Add AppHeader to layout so it appears on all pages
       - Wrap children in a main container with appropriate padding below header

    Use shadcn components throughout: Card, Tabs, Select, Input, Switch, Button, Label.
    Handle Zustand hydration: use a mounted check (useEffect + useState) to prevent SSR mismatch — don't render store-dependent UI until client-side hydrated.
  </action>
  <verify>
    - `pnpm run build` passes
    - `pnpm run dev` shows settings page at /settings
    - Provider tabs switch between OpenAI/Anthropic/OpenRouter
    - API key input shows/hides password
    - Model dropdown populates with correct models per provider
    - Mode toggle switches between Simple/Advanced
    - Settings persist after page refresh (localStorage)
  </verify>
  <done>
    - Settings page with provider selection, model dropdown, API key management (AKEY-01, AKEY-02, AKEY-03, AKEY-04, PROV-01, PROV-02)
    - Mode toggle in app header (MODE-01, MODE-02)
    - Mode persists across sessions via Zustand persist (MODE-04)
    - Switching to Simple doesn't delete Advanced values — store always holds full state (MODE-03)
    - All Phase 1 requirements complete
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm run build` succeeds
- [ ] Settings page renders at /settings with all controls
- [ ] API key input has show/hide toggle
- [ ] Provider switching works and persists
- [ ] Model dropdown shows correct models per provider
- [ ] Mode toggle visible in header and persists
- [ ] API route responds to POST requests (test with curl or similar)
- [ ] localStorage contains soulgen-settings with saved values after interaction
</verification>

<success_criteria>

- All Phase 1 requirements satisfied: AKEY-01-04, PROV-01-03, MODE-01-04, PERS-01, PERS-02
- Streaming API route functional
- Settings page complete with all management controls
- Mode toggle in header
- All state persists to localStorage
  </success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
