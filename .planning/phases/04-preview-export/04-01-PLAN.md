---
phase: 04-preview-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/file-preview.tsx
  - src/components/generation-view.tsx
  - src/hooks/use-file-history.ts
  - src/types/index.ts
autonomous: true
---

<objective>
Enhanced file preview with markdown rendering, edit mode, clipboard copy, and session-local version history.

Purpose: Transform the basic file display into a full preview/edit experience where users can toggle between rendered markdown and raw editing, copy files individually, and undo/redo changes within the session.
Output: FilePreview component with markdown rendering, edit toggle, clipboard copy, and version history hooks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-llm-generation/03-01-SUMMARY.md

@src/components/generation-view.tsx
@src/stores/wizard-store.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create file history hook and enhanced preview types</name>
  <files>src/hooks/use-file-history.ts, src/types/index.ts</files>
  <action>
1. Add types to src/types/index.ts:
   - FileHistory interface: { past: string[], present: string, future: string[] }
   - PreviewMode type: "rendered" | "raw" | "edit"

2. Create src/hooks/use-file-history.ts:
   - useFileHistory(initialContent: string) hook that returns:
     - content: string (current content)
     - setContent: (content: string) => void (pushes to history)
     - undo: () => void (restores from past)
     - redo: () => void (restores from future)
     - canUndo: boolean
     - canRedo: boolean
     - reset: (content: string) => void (resets history with new initial content)
   - Use useState for past/present/future arrays
   - Limit history to 50 entries to avoid memory bloat
   - setContent should push present to past, set new present, clear future
  </action>
  <verify>TypeScript compiles without errors: npx tsc --noEmit</verify>
  <done>FileHistory type exported, useFileHistory hook works with undo/redo/reset</done>
</task>

<task type="auto">
  <name>Task 2: Build FilePreview component with markdown toggle, editing, and clipboard</name>
  <files>src/components/file-preview.tsx, src/components/generation-view.tsx</files>
  <action>
1. Create src/components/file-preview.tsx:
   - Props: { filename: string, content: string, onChange: (content: string) => void, canUndo: boolean, canRedo: boolean, onUndo: () => void, onRedo: () => void }
   - State: previewMode: PreviewMode (default "rendered")
   - Three mode buttons in toolbar: Rendered | Raw | Edit
   - Rendered mode: Parse markdown and render as styled HTML (use simple markdown parsing - headers, bold, italic, code blocks, lists; no need for heavy library)
   - Raw mode: Read-only pre/code block showing raw markdown
   - Edit mode: Textarea with monospace font, full height, edits call onChange
   - Toolbar also includes: Copy to Clipboard button, Undo/Redo buttons (disabled when can't)
   - Copy button uses navigator.clipboard.writeText(), show toast on success via sonner
   - Style with Tailwind: rounded border, proper spacing, dark mode compatible

2. Update src/components/generation-view.tsx:
   - Import FilePreview
   - Replace FileContentTab usage with FilePreview in the completed files view
   - Track edited content separately from original generatedFiles:
     - Add editedFiles state: { soul: string, identity: string, user: string } initialized from files
     - Create useFileHistory instance for each file (soul, identity, user)
   - Pass history controls to FilePreview
   - When files change (regenerate), reset all histories
  </action>
  <verify>npm run build succeeds, no TypeScript errors</verify>
  <done>FilePreview shows three modes (rendered/raw/edit), clipboard copy works with toast, undo/redo functional</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] FilePreview renders markdown correctly (headers, bold, code blocks)
- [ ] Edit mode allows text changes
- [ ] Copy to clipboard works and shows toast
- [ ] Undo/redo navigates through edit history
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- File preview shows rendered markdown by default
- Users can toggle to raw or edit mode
- Clipboard copy works with feedback
- Session-local undo/redo works in edit mode
  </success_criteria>

<output>
After completion, create `.planning/phases/04-preview-export/04-01-SUMMARY.md`
</output>
