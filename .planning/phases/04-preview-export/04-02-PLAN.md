---
phase: 04-preview-export
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/lib/export.ts
  - src/stores/profile-store.ts
  - src/components/export-panel.tsx
  - src/components/profile-manager.tsx
  - src/components/generation-view.tsx
  - src/app/page.tsx
  - src/types/index.ts
autonomous: false
---

<objective>
ZIP export, profile save/load, JSON import, and URL sharing for agent configurations.

Purpose: Complete the export story with ZIP download and individual file copying, plus enable users to save/load/share agent profiles for reuse.
Output: Export panel with ZIP download, profile manager modal, URL-based sharing with copy-to-clipboard.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-preview-export/04-01-SUMMARY.md

@src/components/generation-view.tsx
@src/stores/wizard-store.ts
@src/stores/settings-store.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export utilities and profile store</name>
  <files>src/lib/export.ts, src/stores/profile-store.ts, src/types/index.ts</files>
  <action>
1. Add types to src/types/index.ts:
   - SavedProfile interface: { id: string, name: string, dna: AgentDNA, createdAt: string, updatedAt: string }

2. Create src/lib/export.ts:
   - downloadZip(files: GeneratedFiles): Promise<void>
     - Use dynamic import of 'client-zip' (npm install client-zip)
     - Create ZIP with SOUL.md, IDENTITY.md, USER.md
     - Trigger download as "agent-personality.zip"
   - encodeShareableUrl(dna: AgentDNA): string
     - JSON.stringify the DNA
     - Base64 encode with btoa(encodeURIComponent(...))
     - Return URL with ?dna= query param (use window.location.origin)
   - decodeShareableUrl(url: string): AgentDNA | null
     - Parse URL, extract dna param
     - Base64 decode and JSON.parse
     - Return null if invalid/malformed
   - exportDnaJson(dna: AgentDNA): string
     - Return pretty-printed JSON string
   - importDnaJson(json: string): AgentDNA | null
     - Parse JSON, validate it has required fields (archetype, temperament, etc.)
     - Return null if invalid

3. Create src/stores/profile-store.ts:
   - Zustand store with localStorage persistence
   - State: profiles: SavedProfile[]
   - Actions:
     - saveProfile(name: string, dna: AgentDNA): void (creates new or updates if name matches)
     - loadProfile(id: string): AgentDNA | null
     - deleteProfile(id: string): void
     - renameProfile(id: string, newName: string): void
   - Use nanoid or crypto.randomUUID() for IDs
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>Export utilities work, profile store saves/loads/deletes profiles to localStorage</done>
</task>

<task type="auto">
  <name>Task 2: Build export panel and profile manager UI</name>
  <files>src/components/export-panel.tsx, src/components/profile-manager.tsx, src/components/generation-view.tsx</files>
  <action>
1. Create src/components/export-panel.tsx:
   - Props: { files: GeneratedFiles, dna: AgentDNA }
   - Layout: Card with "Export" title
   - Buttons:
     - "Download ZIP" - calls downloadZip(files), shows loading state
     - "Copy Share Link" - calls encodeShareableUrl(dna), copies to clipboard, shows toast
     - "Export DNA JSON" - calls exportDnaJson(dna), copies to clipboard (for power users)
   - Use lucide icons: Download, Link, FileJson

2. Create src/components/profile-manager.tsx:
   - Props: { currentDna: AgentDNA, onLoadProfile: (dna: AgentDNA) => void }
   - Dialog/modal component with:
     - "Save Current Profile" section: text input for name, Save button
     - "Saved Profiles" list: shows all profiles with Load, Rename (inline edit), Delete buttons
     - "Import from JSON" section: textarea for pasting JSON, Import button with validation feedback
   - Use useProfileStore hook
   - Show empty state if no profiles saved
   - Confirm before delete with simple window.confirm (no need for fancy dialog)

3. Update src/components/generation-view.tsx:
   - Import ExportPanel and ProfileManager
   - Add ExportPanel below the file tabs when files are complete
   - Add "Manage Profiles" button that opens ProfileManager modal
   - Pass onLoadProfile callback that updates wizard store DNA and resets generatedFiles
  </action>
  <verify>npm run build succeeds</verify>
  <done>Export panel shows download/share/json options, profile manager saves/loads/imports profiles</done>
</task>

<task type="auto">
  <name>Task 3: Wire URL sharing with page load detection</name>
  <files>src/app/page.tsx</files>
  <action>
1. In src/app/page.tsx:
   - On mount (useEffect), check for ?dna= query param using window.location.search
   - If found, call decodeShareableUrl() to parse
   - If valid DNA, update wizard store with the loaded DNA via updateDNA() or resetDNA() then updateDNA()
   - Show toast: "Loaded shared agent configuration!"
   - Clear the URL param using window.history.replaceState to clean up URL
   - If invalid, show error toast: "Invalid share link"

2. Handle edge cases:
   - SSR safety: Only access window in useEffect
   - Don't process if dna param is empty string
  </action>
  <verify>npm run build succeeds</verify>
  <done>Opening a share link auto-loads the DNA configuration into the wizard</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete export and profile management system with ZIP download, URL sharing, and profile save/load</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000
    3. Complete wizard and generate files
    4. Test export panel:
       - Click "Download ZIP" - should download agent-personality.zip with 3 files
       - Click "Copy Share Link" - should copy URL to clipboard and show toast
       - Open the copied URL in new tab - should load the same DNA configuration
    5. Test profile manager:
       - Open profile manager, save current profile with a name
       - Reset wizard (if possible) or modify DNA
       - Load the saved profile - should restore DNA
       - Delete a profile, confirm deletion works
    6. Test JSON import:
       - Copy DNA JSON from "Export DNA JSON"
       - In profile manager, paste into import textarea
       - Click Import - should load the configuration
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] ZIP download produces valid zip with 3 markdown files
- [ ] Share link round-trips correctly (encode → copy → open → decode)
- [ ] Profiles persist in localStorage across page reloads
- [ ] JSON import validates and loads valid configurations
- [ ] Human verification passed
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- ZIP export works and contains correctly named files
- URL sharing encodes and decodes DNA correctly
- Profile save/load/delete works with localStorage persistence
- JSON import validates input before loading
  </success_criteria>

<output>
After completion, create `.planning/phases/04-preview-export/04-02-SUMMARY.md`
</output>
